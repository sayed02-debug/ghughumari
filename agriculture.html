<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>কৃষি - ঘুঘুমারী</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .weather-card { border-radius: 20px; overflow: hidden; }
    .forecast-day { font-size: 0.85rem; }
    .alert-box { background: #fff3cd; border-left: 5px solid #ffc107; padding: 12px; border-radius: 10px; margin-top: 15px; }
    .alert-danger { background: #f8d7da; border-left: 5px solid #dc3545; }
    .chat-card { max-width: 900px; margin: 0 auto; }
    .chat-window { height: 400px; overflow-y: auto; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
    .chat-bubble { display: inline-block; padding: 10px 14px; margin: 6px 0; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
    .chat-user { background: #d1e7dd; align-self: flex-end; margin-left: auto; }
    .chat-ai { background: #e2e3e5; align-self: flex-start; margin-right: auto; }
    .chat-row { display: flex; margin-bottom: 8px; }
    .chat-controls .form-control { min-width: 0; }
  </style>
</head>
<body>

  <!-- নেভবার -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top shadow">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">ঘুঘুমারী</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">হোম</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">পরিচয়</a></li>
          <li class="nav-item"><a class="nav-link" href="education.html">শিক্ষা</a></li>
          <li class="nav-item"><a class="nav-link" href="development.html">উন্নয়ন</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html#beauty">সৌন্দর্য</a></li>
          <li class="nav-item"><a class="nav-link" href="welfare.html">কল্যাণ</a></li>
          <li class="nav-item"><a class="nav-link active" href="agriculture.html">কৃষি</a></li>
          <li class="nav-item"><a class="nav-link" href="emergency.html">জরুরি</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">যোগাযোগ</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- হেডার -->
  <section class="py-5 bg-success text-white text-center">
    <div class="container pt-5">
      <h1 class="display-5 fw-bold">কৃষি ও কৃষক সেবা</h1>
      <p class="lead">লাইভ আবহাওয়া + Gemini AI চ্যাটবট</p>
    </div>
  </section>

  <!-- Gemini AI চ্যাটবট -->
  <section class="container my-5">
    <div class="card shadow-sm chat-card">
      <div class="card-body">
        <h4 class="mb-3 text-success">Gemini AI — আপনার কৃষি সহকারী</h4>
        <p class="text-muted small mb-3">
          ধানে পোকা, পাতা হলুদ, সারের পরিমাণ — যা জানতে চান, লিখুন। 
          <strong>বাংলায় লিখুন!</strong>
        </p>
        <div id="chat-window" class="chat-window d-flex flex-column mb-3">
          <div class="text-muted small">চ্যাট শুরু করুন...</div>
        </div>
        <div class="input-group">
          <input type="text" id="chat-input" class="form-control" placeholder="উদাহরণ: ধানে পোকা হয়েছে, কী করব?">
          <button class="btn btn-success" id="chat-send">পাঠান</button>
          <button class="btn btn-outline-secondary" id="chat-clear">মুছে ফেলুন</button>
        </div>
      </div>
    </div>
  </section>

  <!-- লাইভ আবহাওয়া -->
  <section class="container my-5">
    <div class="card weather-card shadow-lg">
      <div class="card-body text-center p-4">
        <h3 class="mb-3">লাইভ আবহাওয়া (ঘুঘুমারী, নীলফামারী)</h3>
        <div id="weather-today" class="display-5 fw-bold text-primary mb-2">লোড হচ্ছে...</div>
        <div id="weather-details" class="text-muted mb-3"></div>
        <div id="weather-forecast" class="mt-4"></div>
        <div id="weather-alert" class="alert-box d-none"></div>
      </div>
    </div>
  </section>

  <!-- জাতীয় হেল্পলাইন -->
  <section class="container my-5">
    <h3 class="text-center mb-4 fw-bold">জাতীয় হেল্পলাইন</h3>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card text-center shadow-sm h-100 border-0">
          <div class="card-body d-flex flex-column justify-content-center">
            <h1 class="text-success fw-bold">৩৩৩</h1>
            <p class="mb-0">জাতীয় হেল্পলাইন</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center shadow-sm h-100 border-0">
          <div class="card-body d-flex flex-column justify-content-center">
            <h1 class="text-primary fw-bold">১৬৭৬৭</h1>
            <p class="mb-0">কৃষি হেল্পলাইন</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center shadow-sm h-100 border-0">
          <div class="card-body d-flex flex-column justify-content-center">
            <h1 class="text-danger fw-bold">৯৯৯</h1>
            <p class="mb-0">জরুরি সেবা</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ফুটার -->
  <footer class="bg-dark text-white text-center py-4">
    <div class="container">
      <p class="mb-1 fw-bold">© ২০২৫ ঘুঘুমারী</p>
      <p class="mb-0 small">ডেভেলপ করেছেন: <strong>Abu Sayed Islam</strong></p>
    </div>
  </footer>

  <!-- WhatsApp Float -->
  <a href="https://wa.me/8801521703362" class="whatsapp-float" target="_blank">
    <i class="fab fa-whatsapp"></i>
  </a>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const WEATHER_API_KEY = '6561455c200e43306bb6913524c5eeb1';
    const PROXY_BASE = 'https://ghughumari.onrender.com';
    const PREFERRED_MODEL = 'gemini-1.5-flash'; // NEW WORKING MODEL

    // Weather
    async function loadWeather() {
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Nilphamari,BD&appid=${WEATHER_API_KEY}&units=metric&lang=bn`);
        const data = await res.json();
        document.getElementById('weather-today').innerHTML = `${Math.round(data.main.temp)}°সে | ${data.weather[0].description}`;
        document.getElementById('weather-details').innerHTML = `<small>আর্দ্রতা: ${data.main.humidity}% | বাতাস: ${Math.round(data.wind.speed * 3.6)} কিমি/ঘণ্টা</small>`;
      } catch {
        document.getElementById('weather-today').innerHTML = '২৮°সে | সূর্যালোকিত';
      }
    }

    // Chat
    const chatMessages = [];
    function renderChat() {
      const win = document.getElementById('chat-window');
      win.innerHTML = chatMessages.length ? '' : '<div class="text-muted small">চ্যাট শুরু করুন...</div>';
      chatMessages.forEach(m => {
        const row = document.createElement('div');
        row.className = 'chat-row';
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${m.role === 'user' ? 'chat-user' : 'chat-ai'}`;
        bubble.innerHTML = `<strong>${m.role === 'user' ? 'আপনি' : 'Gemini'}:</strong><br>${escapeHtml(m.text)}`;
        row.appendChild(bubble);
        win.appendChild(row);
      });
      win.scrollTop = win.scrollHeight;
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      chatMessages.push({ role: 'user', text });
      renderChat();
      input.value = '';

      chatMessages.push({ role: 'assistant', text: 'চিন্তা করছি...' });
      renderChat();

      try {
        const prompt = `তুমি একজন বাংলাদেশী কৃষি বিশেষজ্ঞ। সহজ বাংলায় উত্তর দাও।\nকৃষক: ${text}`;
        const res = await fetch(`${PROXY_BASE}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            model: PREFERRED_MODEL, 
            prompt, 
            temperature: 0.4,
            maxOutputTokens: 300 
          })
        });

        const data = await res.json();
        let answer = data.outputText || 'দুঃখিত, উত্তর পাওয়া যায়নি।';

        if (data.error) {
          answer = `সমস্যা: ${data.error.message}`;
        }

        chatMessages.pop();
        chatMessages.push({ role: 'assistant', text: answer });
        renderChat();
      } catch (err) {
        chatMessages.pop();
        chatMessages.push({ role: 'assistant', text: 'ইন্টারনেট সমস্যা। হেল্পলাইন: ১৬৭৬৭' });
        renderChat();
      }
    }

    // Events
    window.addEventListener('load', loadWeather);
    document.addEventListener('DOMContentLoaded', () => {
      renderChat();
      document.getElementById('chat-send').onclick = sendChatMessage;
      document.getElementById('chat-input').onkeypress = e => { if (e.key === 'Enter') sendChatMessage(); };
      document.getElementById('chat-clear').onclick = () => { chatMessages.length = 0; renderChat(); };
    });
  </script>
</body>
</html>